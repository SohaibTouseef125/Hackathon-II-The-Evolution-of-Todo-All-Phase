# Next.js Setup and Optimization Guides

## Project Initialization

### Creating a Next.js Project
```bash
# Using create-next-app
npx create-next-app@latest my-app --typescript --tailwind --eslint --app --src-dir --import-alias "@/*"

# Manual setup
mkdir my-app
cd my-app
npm init -y
npm install next react react-dom typescript @types/react @types/node @types/react-dom --save
npm install -D tailwindcss postcss autoprefixer eslint
npx tailwindcss init -p
```

### Basic Configuration Files

#### tsconfig.json
```json
{
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "es6"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
```

#### tailwind.config.js
```js
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    './src/pages/**/*.{js,ts,jsx,tsx,mdx}',
    './src/components/**/*.{js,ts,jsx,tsx,mdx}',
    './src/app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    extend: {
      backgroundImage: {
        'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))',
        'gradient-conic': 'conic-gradient(from 180deg at 50% 50%, var(--tw-gradient-stops))',
      },
    },
  },
  plugins: [],
}
```

## App Router Implementation

### Layout Structure
```tsx
// app/layout.tsx
import './globals.css'
import type { Metadata } from 'next'
import { Inter } from 'next/font/google'

const inter = Inter({ subsets: ['latin'] })

export const metadata: Metadata = {
  title: 'Create Next App',
  description: 'Generated by create next app',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en">
      <body className={inter.className}>{children}</body>
    </html>
  )
}
```

### Page Structure with Loading and Error Boundaries
```tsx
// app/page.tsx
import { Suspense } from 'react'
import Feed from './feed'

export default function Page() {
  return (
    <div>
      <h1>My App</h1>
      <Suspense fallback={<p>Loading feed...</p>}>
        <Feed />
      </Suspense>
    </div>
  )
}
```

### Dynamic Routes
```tsx
// app/products/[id]/page.tsx
type Props = {
  params: { id: string }
  searchParams: { [key: string]: string | string[] | undefined }
}

export async function generateMetadata({ params }: Props): Promise<Metadata> {
  const product = await getProduct(params.id)

  return {
    title: product.name,
  }
}

export default function Page({ params, searchParams }: Props) {
  return <div>Product ID: {params.id}</div>
}
```

## Data Fetching Strategies

### Server-Side Rendering (SSR)
```tsx
// app/products/page.tsx
import { Product } from '@/types'

async function getProducts(): Promise<Product[]> {
  // This will be executed on the server
  const res = await fetch('https://api.example.com/products', {
    headers: {
      'Cache-Control': 'no-store', // Disable caching for this request
    },
  })
  return res.json()
}

export default async function ProductsPage() {
  const products = await getProducts()

  return (
    <div>
      {products.map(product => (
        <div key={product.id}>{product.name}</div>
      ))}
    </div>
  )
}
```

### Static Site Generation (SSG)
```tsx
// app/products/[id]/page.tsx
import { notFound } from 'next/navigation'

async function getProduct(id: string) {
  const res = await fetch(`https://api.example.com/products/${id}`)

  if (!res.ok) {
    notFound()
  }

  return res.json()
}

// Generate static pages at build time
export async function generateStaticParams() {
  const res = await fetch('https://api.example.com/products')
  const products: { id: string }[] = await res.json()

  return products.map((product) => ({
    id: product.id,
  }))
}

export default async function ProductPage({ params }: { params: { id: string } }) {
  const product = await getProduct(params.id)

  return <div>{product.name}</div>
}
```

### Incremental Static Regeneration (ISR)
```tsx
// app/products/[id]/page.tsx
async function getProduct(id: string) {
  const res = await fetch(`https://api.example.com/products/${id}`, {
    next: { revalidate: 3600 } // Revalidate every hour
  })
  return res.json()
}

export default async function ProductPage({ params }: { params: { id: string } }) {
  const product = await getProduct(params.id)

  return <div>{product.name}</div>
}
```

## API Routes

### Basic API Route
```tsx
// app/api/users/route.ts
import { NextRequest } from 'next/server'

export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url)
  const id = searchParams.get('id')

  return Response.json({ message: `User ${id}` })
}

export async function POST(request: NextRequest) {
  const body = await request.json()

  // Process the request body
  return Response.json({ message: 'User created', user: body })
}
```

### API Route with Validation
```tsx
// app/api/users/[id]/route.ts
import { NextRequest } from 'next/server'

export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  const userId = params.id

  // Validate the ID
  if (!/^[0-9a-fA-F]{24}$/.test(userId)) {
    return Response.json({ error: 'Invalid user ID' }, { status: 400 })
  }

  const user = await getUserById(userId)

  if (!user) {
    return Response.json({ error: 'User not found' }, { status: 404 })
  }

  return Response.json(user)
}

export async function PUT(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  const userId = params.id
  const body = await request.json()

  // Validate the request body
  const validatedBody = validateUserUpdate(body)

  if (!validatedBody.isValid) {
    return Response.json({ errors: validatedBody.errors }, { status: 400 })
  }

  const updatedUser = await updateUser(userId, validatedBody.data)

  return Response.json(updatedUser)
}
```

## Middleware

### Authentication Middleware
```ts
// middleware.ts
import { NextRequest, NextResponse } from 'next/server'

export function middleware(request: NextRequest) {
  // Get the user token from cookies or headers
  const token = request.cookies.get('auth-token')?.value

  // Define protected routes
  const protectedRoutes = ['/dashboard', '/profile']

  // Check if the current route is protected
  const isProtectedRoute = protectedRoutes.some(route =>
    request.nextUrl.pathname.startsWith(route)
  )

  if (isProtectedRoute && !token) {
    // Redirect to login page if not authenticated
    return NextResponse.redirect(new URL('/login', request.url))
  }

  return NextResponse.next()
}

// Specify which paths the middleware should run on
export const config = {
  matcher: [
    /*
     * Match all request paths except for the ones starting with:
     * - api (API routes)
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     */
    '/((?!api|_next/static|_next/image|favicon.ico).*)',
  ],
}
```

## Image Optimization

### Using Next.js Image Component
```tsx
// components/ProductImage.tsx
import Image from 'next/image'

interface ProductImageProps {
  src: string
  alt: string
  width?: number
  height?: number
}

export default function ProductImage({
  src,
  alt,
  width = 800,
  height = 600
}: ProductImageProps) {
  return (
    <Image
      src={src}
      alt={alt}
      width={width}
      height={height}
      // Optional: blur-up effect while loading
      placeholder="blur"
      blurDataURL="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/..."
      // Optional: different loading strategies
      loading="lazy" // or "eager"
      // Optional: priority for above-the-fold images
      priority={false}
      // Optional: responsive sizes
      sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
      // Optional: styling
      className="rounded-lg object-cover"
    />
  )
}
```

## Environment Variables

### Environment Configuration
```bash
# .env.local
NEXT_PUBLIC_API_URL=https://api.example.com
NEXT_PUBLIC_APP_ENV=production
NEXT_PUBLIC_SENTRY_DSN=https://example@sentry.io/123

# Server-side only
DATABASE_URL=postgresql://user:password@localhost:5432/mydb
SECRET_KEY=your-secret-key
```

### Using Environment Variables
```ts
// lib/config.ts
export const config = {
  api: {
    baseUrl: process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3000/api',
    timeout: 10000,
  },
  sentry: {
    dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  },
  auth: {
    jwtSecret: process.env.SECRET_KEY,
  }
}
```

## Performance Optimization

### Code Splitting with Dynamic Imports
```tsx
// components/LazyComponent.tsx
import dynamic from 'next/dynamic'

// Dynamic import without SSR
const HeavyComponent = dynamic(
  () => import('./HeavyComponent'),
  {
    loading: () => <div>Loading...</div>,
    ssr: false
  }
)

// Dynamic import with named exports
const { Modal } = dynamic(() => import('./Modal'))

// Dynamic import with error boundary
const ComponentWithFallback = dynamic(
  () => import('./Component'),
  {
    loading: () => <div>Loading...</div>,
    error: ({ error }) => <div>Error: {error.message}</div>
  }
)

export default function Page() {
  return (
    <div>
      <Header />
      <HeavyComponent />
      <Modal />
      <ComponentWithFallback />
    </div>
  )
}
```

### Font Optimization
```ts
// app/layout.tsx
import { Inter, Roboto } from 'next/font/google'

const inter = Inter({
  subsets: ['latin'],
  display: 'swap',
})

const roboto = Roboto({
  weight: ['400', '700'],
  subsets: ['latin'],
  display: 'swap',
})

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en" className={`${inter.className} ${roboto.className}`}>
      <body>{children}</body>
    </html>
  )
}
```

## Security Headers

### Custom Headers Configuration
```js
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  async headers() {
    return [
      {
        // Apply these headers to all routes in your application
        source: '/(.*)',
        headers: [
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff',
          },
          {
            key: 'X-Frame-Options',
            value: 'DENY',
          },
          {
            key: 'X-XSS-Protection',
            value: '1; mode=block',
          },
          {
            key: 'Referrer-Policy',
            value: 'strict-origin-when-cross-origin',
          },
          {
            key: 'Content-Security-Policy',
            value: "default-src 'self'; script-src 'self' 'unsafe-inline' https://*.googletagmanager.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://*.sentry.io;",
          },
        ],
      },
    ]
  },
}

module.exports = nextConfig
```

## Build Optimization

### Webpack Configuration
```js
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  webpack: (config, { isServer }) => {
    // Add your webpack configuration here
    if (!isServer) {
      // Configuration for client-side only
      config.resolve.fallback = {
        ...config.resolve.fallback,
        fs: false,
      }
    }

    return config
  },

  // Optimize compilation
  experimental: {
    turbo: {
      // Enable turbo mode for faster builds
    },
  },
}

module.exports = nextConfig
```

## Environment-Specific Configuration

### Multi-environment Setup
```js
// next.config.js
const isProd = process.env.NODE_ENV === 'production'

/** @type {import('next').NextConfig} */
const nextConfig = {
  // Use asset prefix in production
  assetPrefix: isProd ? 'https://cdn.example.com' : undefined,

  // Disable source maps in production
  swcMinify: true,

  // Optimize for production
  experimental: {
    optimizePackageImports: ['@heroicons/react'],
  },

  images: {
    // In production, use a CDN for images
    domains: isProd
      ? ['cdn.example.com', 'images.example.com']
      : ['localhost', 'example.com'],
  },
}

module.exports = nextConfig
```

This guide provides comprehensive Next.js configuration patterns for production applications, covering initialization, routing, data fetching, security, and optimization techniques.